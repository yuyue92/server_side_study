<!DOCTYPE html>
<html>

<head>
    <title>Todo App</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        .todo-form {
            background: #f5f5f5;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 10px;
        }
        #todoList {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-add {
            background: #007bff;
            color: white;
        }

        .btn-toggle {
            background: #28a745;
            color: white;
        }

        .btn-edit {
            background: #ffc107;
            color: black;
        }

        .btn-save {
            background: #17a2b8;
            color: white;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .todo-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .todo-item.completed {
            opacity: 0.6;
            background: #f8f9fa;
        }

        .completed .todo-title {
            text-decoration: line-through;
        }

        .todo-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .todo-description {
            margin: 10px 0;
            color: #555;
        }

        .todo-meta {
            font-size: 0.8em;
            color: #666;
            margin: 10px 0;
        }

        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .edit-form {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .edit-form input,
        .edit-form textarea {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1>üìù Todo App</h1>

    <div class="todo-form">
        <h3>Ê∑ªÂä†Êñ∞‰ªªÂä°</h3>
        <form id="addTodoForm">
            <div class="form-group">
                <input type="text" id="title" placeholder="‰ªªÂä°Ê†áÈ¢ò" required>
            </div>
            <div class="form-group">
                <textarea id="description" placeholder="‰ªªÂä°ÊèèËø∞"></textarea>
            </div>
            <button type="submit" class="btn-add">Ê∑ªÂä†‰ªªÂä°</button>
        </form>
    </div>

    <div id="messageArea"></div>
    <div id="todoList">Âä†ËΩΩ‰∏≠...</div>

    <script>
        const API_BASE = '/api';
        let editingId = null; // ÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑtodo ID

        function showMessage(text, type = 'success') {
            const area = document.getElementById('messageArea');
            area.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => area.innerHTML = '', 3000);
        }

        async function loadTodos() {
            try {
                const res = await fetch(API_BASE + '/todos');
                const data = await res.json();

                if (data.success) {
                    displayTodos(data.data);
                } else {
                    throw new Error('Âä†ËΩΩÂ§±Ë¥•');
                }
            } catch (error) {
                document.getElementById('todoList').innerHTML = 'Âä†ËΩΩÂ§±Ë¥•: ' + error.message;
            }
        }

        function displayTodos(todos) {
            const list = document.getElementById('todoList');

            if (todos.length === 0) {
                list.innerHTML = '<p>ÊöÇÊó†‰ªªÂä°ÔºåÊ∑ªÂä†Á¨¨‰∏Ä‰∏™‰ªªÂä°ÂºÄÂßãÂêßÔºÅ</p>';
                return;
            }

            list.innerHTML = todos.map(todo => {
                if (todo.id === editingId) {
                    // ÁºñËæëÊ®°Âºè
                    return `
                        <div class="todo-item ${todo.completed ? 'completed' : ''}">
                            <div class="edit-form">
                                <input type="text" id="edit-title-${todo.id}" value="${todo.title}" placeholder="‰ªªÂä°Ê†áÈ¢ò">
                                <textarea id="edit-description-${todo.id}" placeholder="‰ªªÂä°ÊèèËø∞">${todo.description || ''}</textarea>
                                <div>
                                    <button class="btn-save" onclick="saveTodo(${todo.id})">‰øùÂ≠ò</button>
                                    <button class="btn-cancel" onclick="cancelEdit(${todo.id})">ÂèñÊ∂à</button>
                                </div>
                            </div>
                            <div class="todo-meta">
                                ÂàõÂª∫: ${new Date(todo.created_at).toLocaleString()} |
                                Áä∂ÊÄÅ: ${todo.completed ? 'Â∑≤ÂÆåÊàê' : 'Êú™ÂÆåÊàê'}
                            </div>
                        </div>
                    `;
                } else {
                    // Êü•ÁúãÊ®°Âºè
                    return `
                        <div class="todo-item ${todo.completed ? 'completed' : ''}">
                            <div class="todo-title">${todo.title}</div>
                            ${todo.description ? `<div class="todo-description">${todo.description}</div>` : ''}
                            <div class="todo-meta">
                                ÂàõÂª∫: ${new Date(todo.created_at).toLocaleString()} |
                                Êõ¥Êñ∞: ${new Date(todo.updated_at).toLocaleString()} |
                                Áä∂ÊÄÅ: ${todo.completed ? 'Â∑≤ÂÆåÊàê' : 'Êú™ÂÆåÊàê'}
                            </div>
                            <div>
                                <button class="btn-toggle" onclick="toggleTodo(${todo.id})">
                                    ${todo.completed ? 'Ê†áËÆ∞Êú™ÂÆåÊàê' : 'Ê†áËÆ∞ÂÆåÊàê'}
                                </button>
                                <button class="btn-edit" onclick="startEdit(${todo.id})">ÁºñËæë</button>
                                <button class="btn-delete" onclick="deleteTodo(${todo.id})">Âà†Èô§</button>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        async function addTodo(todoData) {
            try {
                const res = await fetch(API_BASE + '/todos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(todoData)
                });
                const data = await res.json();

                if (data.success) {
                    showMessage('Ê∑ªÂä†ÊàêÂäü');
                    document.getElementById('addTodoForm').reset();
                    loadTodos();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showMessage('Ê∑ªÂä†Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ÂºÄÂßãÁºñËæë
        function startEdit(id) {
            editingId = id;
            loadTodos();
        }

        // ÂèñÊ∂àÁºñËæë
        function cancelEdit(id) {
            editingId = null;
            loadTodos();
        }

        // ‰øùÂ≠òÁºñËæë
        async function saveTodo(id) {
            const title = document.getElementById(`edit-title-${id}`).value.trim();
            const description = document.getElementById(`edit-description-${id}`).value.trim();

            if (!title) {
                showMessage('Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫', 'error');
                return;
            }

            try {
                const res = await fetch(API_BASE + '/todos/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: description
                    })
                });
                const data = await res.json();

                if (data.success) {
                    showMessage('Êõ¥Êñ∞ÊàêÂäü');
                    editingId = null;
                    loadTodos();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showMessage('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        async function toggleTodo(id) {
            try {
                const res = await fetch(API_BASE + '/todos/' + id + '/toggle', {
                    method: 'PATCH'
                });
                const data = await res.json();

                if (data.success) {
                    showMessage(data.message);
                    loadTodos();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showMessage('Êìç‰ΩúÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        async function deleteTodo(id) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ëøô‰∏™‰ªªÂä°ÂêóÔºü')) return;

            try {
                const res = await fetch(API_BASE + '/todos/' + id, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    showMessage('Âà†Èô§ÊàêÂäü');
                    loadTodos();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showMessage('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        document.getElementById('addTodoForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();

            if (!title) {
                showMessage('ËØ∑ËæìÂÖ•Ê†áÈ¢ò', 'error');
                return;
            }

            addTodo({ title, description, completed: false });
        });

        // ÂàùÂßãÂåñ
        loadTodos();
    </script>
</body>

</html>