<!DOCTYPE html>
<html>

<head>
    <title>Todo App</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        .todo-form {
            background: #f5f5f5;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 10px;
        }
        #todoList {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-add {
            background: #007bff;
            color: white;
        }

        .btn-toggle {
            background: #28a745;
            color: white;
        }

        .btn-edit {
            background: #ffc107;
            color: black;
        }

        .btn-save {
            background: #17a2b8;
            color: white;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .todo-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .todo-item.completed {
            opacity: 0.6;
            background: #f8f9fa;
        }

        .completed .todo-title {
            text-decoration: line-through;
        }

        .todo-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .todo-description {
            margin: 10px 0;
            color: #555;
        }

        .todo-meta {
            font-size: 0.8em;
            color: #666;
            margin: 10px 0;
        }

        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .edit-form {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .edit-form input,
        .edit-form textarea {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1>ğŸ“ Todo App</h1>

    <div class="todo-form">
        <h3>æ·»åŠ æ–°ä»»åŠ¡</h3>
        <form id="addTodoForm">
            <div class="form-group">
                <input type="text" id="title" placeholder="ä»»åŠ¡æ ‡é¢˜" required>
            </div>
            <div class="form-group">
                <textarea id="description" placeholder="ä»»åŠ¡æè¿°"></textarea>
            </div>
            <button type="submit" class="btn-add">æ·»åŠ ä»»åŠ¡</button>
        </form>
    </div>

    <div id="messageArea"></div>
    <div id="todoList">åŠ è½½ä¸­...</div>

    <script>
        const API_BASE = '/api';
        let editingId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„todo ID

        function showMessage(text, type = 'success') {
            const area = document.getElementById('messageArea');
            area.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => area.innerHTML = '', 3000);
        }

        async function loadTodos() {
            try {
                const res = await fetch(API_BASE + '/todos');
                const data = await res.json();

                if (data.success) {
                    displayTodos(data.data);
                } else {
                    throw new Error('åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('todoList').innerHTML = 'åŠ è½½å¤±è´¥: ' + error.message;
            }
        }

        function displayTodos(todos) {
            const list = document.getElementById('todoList');

            if (todos.length === 0) {
                list.innerHTML = '<p>æš‚æ— ä»»åŠ¡ï¼Œæ·»åŠ ç¬¬ä¸€ä¸ªä»»åŠ¡å¼€å§‹å§ï¼</p>';
                return;
            }

            list.innerHTML = todos.map(todo => {
                if (todo.id === editingId) {
                    // ç¼–è¾‘æ¨¡å¼
                    return `
                        <div class="todo-item ${todo.completed ? 'completed' : ''}">
                            <div class="edit-form">
                                <input type="text" id="edit-title-${todo.id}" value="${todo.title}" placeholder="ä»»åŠ¡æ ‡é¢˜">
                                <textarea id="edit-description-${todo.id}" placeholder="ä»»åŠ¡æè¿°">${todo.description || ''}</textarea>
                                <div>
                                    <button class="btn-save" onclick="saveTodo(${todo.id})">ä¿å­˜</button>
                                    <button class="btn-cancel" onclick="cancelEdit(${todo.id})">å–æ¶ˆ</button>
                                </div>
                            </div>
                            <div class="todo-meta">
                                åˆ›å»º: ${new Date(todo.created_at).toLocaleString()} |
                                çŠ¶æ€: ${todo.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}
                            </div>
                        </div>
                    `;
                } else {
                    // æŸ¥çœ‹æ¨¡å¼
                    return `
                        <div class="todo-item ${todo.completed ? 'completed' : ''}">
                            <div class="todo-title">${todo.title}</div>
                            ${todo.description ? `<div class="todo-description">${todo.description}</div>` : ''}
                            <div class="todo-meta">
                                åˆ›å»º: ${new Date(todo.created_at).toLocaleString()} |
                                æ›´æ–°: ${new Date(todo.updated_at).toLocaleString()} |
                                çŠ¶æ€: ${todo.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}
                            </div>
                            <div>
                                <button class="btn-toggle" onclick="toggleTodo(${todo.id})">
                                    ${todo.completed ? 'æ ‡è®°æœªå®Œæˆ' : 'æ ‡è®°å®Œæˆ'}
                                </button>
                                <button class="btn-edit" onclick="startEdit(${todo.id})">ç¼–è¾‘</button>
                                <button class="btn-delete" onclick="deleteTodo(${todo.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        async function addTodo(todoData) {
            try {
                const res = await fetch(API_BASE + '/todos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(todoData)
                });
                const data = await res.json();

                if (data.success) {
                    showMessage('æ·»åŠ æˆåŠŸ');
                    document.getElementById('addTodoForm').reset();
                    loadTodos();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¼€å§‹ç¼–è¾‘
        function startEdit(id) {
            editingId = id;
            loadTodos();
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit(id) {
            editingId = null;
            loadTodos();
        }

        // ä¿å­˜ç¼–è¾‘
        async function saveTodo(id) {
            const title = document.getElementById(`edit-title-${id}`).value.trim();
            const description = document.getElementById(`edit-description-${id}`).value.trim();

            if (!title) {
                showMessage('æ ‡é¢˜ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            try {
                const res = await fetch(API_BASE + '/todos/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: description
                    })
                });
                const data = await res.json();

                if (data.success) {
                    showMessage('æ›´æ–°æˆåŠŸ');
                    editingId = null;
                    loadTodos();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function toggleTodo(id) {
            try {
                const res = await fetch(API_BASE + '/todos/' + id + '/toggle', {
                    method: 'PATCH'
                });
                const data = await res.json();

                if (data.success) {
                    showMessage(data.message);
                    loadTodos();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showMessage('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteTodo(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                const res = await fetch(API_BASE + '/todos/' + id, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.success) {
                    showMessage('åˆ é™¤æˆåŠŸ');
                    loadTodos();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('addTodoForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();

            if (!title) {
                showMessage('è¯·è¾“å…¥æ ‡é¢˜', 'error');
                return;
            }

            addTodo({ title, description, completed: false });
        });

        // åˆå§‹åŒ–
        loadTodos();
    </script>
</body>

</html>