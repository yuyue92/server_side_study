<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>用户主从信息 CRUD 示例</title>
    <style>
        :root {
            --gap: 12px;
            --radius: 12px
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0;
            background: #f7f7f8;
            color: #222
        }

        header {
            position: sticky;
            top: 0;
            background: #fff;
            border-bottom: 1px solid #eee;
            padding: 14px 18px;
            display: flex;
            flex-wrap: wrap;
            gap: var(--gap);
            align-items: center;
            z-index: 100;
        }

        header h1 {
            font-size: 18px;
            margin: 0;
            margin-right: auto
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--gap)
        }

        input,
        select,
        textarea,
        button {
            font: inherit
        }

        input,
        select,
        textarea {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fff;
            min-width: 140px
        }

        button {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 999px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #f5f5f5;
        }

        button.primary {
            background: #111;
            color: #fff;
            border-color: #111
        }

        button.primary:hover {
            background: #333;
        }

        button.danger {
            background: #ffeded;
            color: #b10000;
            border-color: #ffbebe
        }

        button.danger:hover {
            background: #ffd5d5;
        }

        main {
            padding: 18px
        }

        .card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: var(--radius);
            padding: 14px
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
            vertical-align: top
        }

        th {
            font-weight: 600;
            color: #444;
            background: #fafafa
        }

        .muted {
            opacity: .65
        }

        .row-actions>button {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 13px;
        }

        .pagination {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-end;
            margin-top: 12px
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid #ddd
        }

        .status-active {
            background: #e8fff1;
            border-color: #b9f4d0;
            color: #0b7a3a
        }

        .status-inactive {
            background: #fff7e6;
            border-color: #ffe1ae;
            color: #8a5a00
        }

        .status-suspended {
            background: #ffe8e8;
            border-color: #ffc8c8;
            color: #b10000
        }

        dialog {
            border: none;
            border-radius: 16px;
            width: min(920px, 95vw);
            padding: 0;
            overflow: hidden
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
        }

        .dialog-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
            background: #fafafa
        }

        .dialog-body {
            padding: 16px;
            max-height: 70vh;
            overflow: auto
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 12px
        }

        .col-6 {
            grid-column: span 6
        }

        .col-4 {
            grid-column: span 4
        }

        .col-3 {
            grid-column: span 3
        }

        .col-12 {
            grid-column: span 12
        }

        .field label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .field input,
        .field select,
        .field textarea {
            width: 100%
        }

        .dialog-foot {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 12px 16px;
            border-top: 1px solid #eee;
            background: #fafafa
        }

        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #eee
        }

        .nowrap {
            white-space: nowrap
        }

        .chip {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px 4px 0 0;
            background: #f0f0f0;
            border-radius: 999px;
            font-size: 12px
        }

        .help {
            font-size: 12px;
            color: #777;
            margin-top: 4px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        @media (max-width: 768px) {

            .col-6,
            .col-4,
            .col-3 {
                grid-column: span 12;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>用户主从信息管理（Fiber + SQLite）</h1>
        <div class="controls">
            <input id="q_name" placeholder="按姓名搜索" />
            <input id="q_email" placeholder="按邮箱搜索" />
            <select id="q_status">
                <option value="">全部状态</option>
                <option value="active">active</option>
                <option value="inactive">inactive</option>
                <option value="suspended">suspended</option>
            </select>
            <select id="q_pagesize">
                <option>5</option>
                <option selected>10</option>
                <option>20</option>
                <option>50</option>
            </select>
            <button id="btnSearch">搜索</button>
            <button id="btnCreate" class="primary">+ 新建用户</button>
        </div>
    </header>

    <main>
        <section class="card">
            <div style="overflow:auto">
                <table>
                    <thead>
                        <tr>
                            <th class="nowrap">ID</th>
                            <th>用户</th>
                            <th>邮箱</th>
                            <th>状态</th>
                            <th>城市</th>
                            <th>技能</th>
                            <th style="width:140px">操作</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
            <div class="pagination">
                <span class="muted" id="pg_info">第 1/1 页，共 0 条</span>
                <button id="prev">上一页</button>
                <button id="next">下一页</button>
            </div>
        </section>
    </main>

    <dialog id="dlg">
        <form method="dialog" id="formUser">
            <div class="dialog-head">
                <strong id="dlg_title">新建用户</strong>
                <button type="button" id="dlg_close">×</button>
            </div>
            <div class="dialog-body">
                <div class="grid">
                    <div class="field col-6">
                        <label>姓名 *</label>
                        <input name="name" required />
                    </div>
                    <div class="field col-3">
                        <label>年龄 *</label>
                        <input name="age" type="number" min="0" max="150" required />
                    </div>
                    <div class="field col-3">
                        <label>状态 *</label>
                        <select name="status" required>
                            <option value="active">active</option>
                            <option value="inactive">inactive</option>
                            <option value="suspended">suspended</option>
                        </select>
                    </div>

                    <div class="field col-6">
                        <label>邮箱 *</label>
                        <input name="email" type="email" required />
                    </div>
                    <div class="field col-6">
                        <label>电话</label>
                        <input name="phone" />
                    </div>

                    <div class="field col-12">
                        <label>住址</label>
                        <input name="address" />
                    </div>
                    <div class="field col-4">
                        <label>城市</label>
                        <input name="city" />
                    </div>
                    <div class="field col-4">
                        <label>国家/地区</label>
                        <input name="country" />
                    </div>
                    <div class="field col-4">
                        <label>邮编</label>
                        <input name="postal_code" />
                    </div>

                    <div class="field col-4">
                        <label>性别</label>
                        <select name="gender">
                            <option value="">-</option>
                            <option value="male">male</option>
                            <option value="female">female</option>
                            <option value="other">other</option>
                        </select>
                    </div>
                    <div class="field col-4">
                        <label>生日</label>
                        <input name="birthday" type="date" />
                    </div>
                    <div class="field col-4">
                        <label>头像 URL</label>
                        <input name="avatar" placeholder="https://..." />
                    </div>

                    <div class="field col-6">
                        <label>职业</label>
                        <input name="occupation" />
                    </div>
                    <div class="field col-6">
                        <label>公司</label>
                        <input name="company" />
                    </div>

                    <div class="field col-4">
                        <label>网站</label>
                        <input name="website" placeholder="https://..." />
                    </div>
                    <div class="field col-4">
                        <label>GitHub</label>
                        <input name="github" placeholder="username" />
                    </div>
                    <div class="field col-4">
                        <label>LinkedIn</label>
                        <input name="linkedin" placeholder="slug" />
                    </div>

                    <div class="field col-6">
                        <label>技能（逗号分隔）</label>
                        <input name="skills" placeholder="Go,React,SQLite" />
                    </div>
                    <div class="field col-6">
                        <label>兴趣（逗号分隔）</label>
                        <input name="interests" placeholder="Hiking,Reading" />
                    </div>

                    <div class="field col-12">
                        <label>简介</label>
                        <textarea name="bio" rows="3"></textarea>
                        <div class="help">带 * 为必填。保存后可在列表直接看到主信息；更多详情可通过表单再次编辑。</div>
                    </div>
                </div>
            </div>
            <div class="dialog-foot">
                <button type="button" id="btnDelete" class="danger" style="display:none">删除</button>
                <div style="flex:1"></div>
                <button type="button" id="btnCancel">取消</button>
                <button type="submit" class="primary" id="btnSubmit">保存</button>
            </div>
        </form>
    </dialog>

    <script>
        // ============================
        // API 配置
        // ============================
        const BASE_URL = 'http://localhost:3000/api';

        const api = {
            // 获取用户列表
            async list({ page = 1, page_size = 10, name = '', email = '', status = '' } = {}) {
                const params = new URLSearchParams({
                    page: page.toString(),
                    page_size: page_size.toString(),
                    include_profile: 'true'
                });
                if (name) params.set('name', name);
                if (email) params.set('email', email);
                if (status) params.set('status', status);

                const res = await fetch(`${BASE_URL}/users?${params.toString()}`);
                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(error);
                }
                return res.json();
            },

            // 获取单个用户
            async get(id) {
                const res = await fetch(`${BASE_URL}/users/${id}?include_profile=true`);
                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(error);
                }
                return res.json();
            },

            // 创建用户（主表 + 从表）
            async create(userData) {
                const res = await fetch(`${BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(error);
                }
                return res.json();
            },

            // 更新用户（主表 + 从表）
            async update(id, userData) {
                // 1. 更新主表
                const mainData = {
                    name: userData.name,
                    age: userData.age,
                    email: userData.email,
                    status: userData.status
                };

                const mainRes = await fetch(`${BASE_URL}/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(mainData)
                });

                if (!mainRes.ok) {
                    const error = await mainRes.text();
                    throw new Error('更新主表失败: ' + error);
                }

                // 2. 更新从表（profile）
                if (userData.profile) {
                    const profileRes = await fetch(`${BASE_URL}/users/${id}/profile`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData.profile)
                    });

                    if (!profileRes.ok) {
                        const error = await profileRes.text();
                        throw new Error('更新详细资料失败: ' + error);
                    }
                }

                return { success: true };
            },

            // 删除用户
            async remove(id) {
                const res = await fetch(`${BASE_URL}/users/${id}`, {
                    method: 'DELETE'
                });

                if (!res.ok && res.status !== 204) {
                    const error = await res.text();
                    throw new Error(error);
                }
                return true;
            }
        };

        // ============================
        // UI 逻辑
        // ============================
        const tbody = document.getElementById('tbody');
        const pgInfo = document.getElementById('pg_info');
        const btnPrev = document.getElementById('prev');
        const btnNext = document.getElementById('next');
        const qName = document.getElementById('q_name');
        const qEmail = document.getElementById('q_email');
        const qStatus = document.getElementById('q_status');
        const qPageSize = document.getElementById('q_pagesize');

        let currentPage = 1;
        let totalPages = 1;

        document.getElementById('btnSearch').addEventListener('click', () => {
            currentPage = 1;
            load();
        });

        document.getElementById('btnCreate').addEventListener('click', () => openDialog());

        btnPrev.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                load();
            }
        });

        btnNext.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                load();
            }
        });

        function statusBadge(s) {
            const cls = s === 'active' ? 'status-active' :
                (s === 'suspended' ? 'status-suspended' : 'status-inactive');
            return `<span class="badge ${cls}">${s || '-'}</span>`;
        }

        function renderRows(list) {
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">暂无数据</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(u => {
                const p = u.profile || {};
                const city = p.city || '';
                const skills = (p.skills || '')
                    .split(',')
                    .filter(Boolean)
                    .slice(0, 3)
                    .map(s => `<span class="chip">${s.trim()}</span>`)
                    .join('');

                return `<tr>
                    <td class="nowrap">${u.id || ''}</td>
                    <td>
                        <div><strong>${u.name || ''}</strong></div>
                        <div class="muted">${p.phone || ''}</div>
                    </td>
                    <td>${u.email || ''}</td>
                    <td>${statusBadge(u.status || '')}</td>
                    <td>${city || '-'}</td>
                    <td>${skills || '-'}</td>
                    <td class="row-actions">
                        <button data-act="edit" data-id="${u.id}">编辑</button>
                        <button data-act="del" data-id="${u.id}" class="danger">删除</button>
                    </td>
                </tr>`;
            }).join('');

            // 行内事件
            tbody.querySelectorAll('button[data-act="edit"]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    try {
                        const result = await api.get(id);
                        openDialog(result.data);
                    } catch (e) {
                        alert('获取用户信息失败: ' + e.message);
                    }
                });
            });

            tbody.querySelectorAll('button[data-act="del"]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    if (confirm('确认删除该用户？此操作不可恢复')) {
                        try {
                            await api.remove(id);
                            load();
                        } catch (e) {
                            alert('删除失败: ' + e.message);
                        }
                    }
                });
            });
        }

        async function load() {
            try {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">加载中...</td></tr>';

                const pageSize = Number(qPageSize.value || 10);
                const result = await api.list({
                    page: currentPage,
                    page_size: pageSize,
                    name: qName.value.trim(),
                    email: qEmail.value.trim(),
                    status: qStatus.value
                });

                console.log('API 返回:', result);

                const { data = [], pagination = {} } = result;
                const { page = 1, total = 0, total_page = 1 } = pagination;

                currentPage = page;
                totalPages = total_page || 1;

                renderRows(data);
                pgInfo.textContent = `第 ${currentPage}/${totalPages} 页，共 ${total} 条`;

                btnPrev.disabled = currentPage <= 1;
                btnNext.disabled = currentPage >= totalPages;
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading" style="color: #b10000;">加载失败: ' + e.message + '</td></tr>';
                console.error('加载失败:', e);
            }
        }

        // ============================
        // 表单对话框（创建/编辑）
        // ============================
        const dlg = document.getElementById('dlg');
        const dlgTitle = document.getElementById('dlg_title');
        const dlgClose = document.getElementById('dlg_close');
        const btnCancel = document.getElementById('btnCancel');
        const btnDelete = document.getElementById('btnDelete');
        const form = document.getElementById('formUser');

        function fillForm(data = {}) {
            const u = data || {};
            const p = u.profile || {};

            form.dataset.id = u.id || '';
            form.name.value = u.name || '';
            form.age.value = u.age || '';
            form.status.value = u.status || 'active';
            form.email.value = u.email || '';
            form.phone.value = p.phone || '';
            form.address.value = p.address || '';
            form.city.value = p.city || '';
            form.country.value = p.country || '';
            form.postal_code.value = p.postal_code || '';
            form.gender.value = p.gender || '';
            form.birthday.value = p.birthday || '';
            form.avatar.value = p.avatar || '';
            form.occupation.value = p.occupation || '';
            form.company.value = p.company || '';
            form.website.value = p.website || '';
            form.github.value = p.github || '';
            form.linkedin.value = p.linkedin || '';
            form.skills.value = p.skills || '';
            form.interests.value = p.interests || '';
            form.bio.value = p.bio || '';
        }

        function collectFormData() {
            return {
                name: form.name.value.trim(),
                age: Number(form.age.value || 0),
                status: form.status.value,
                email: form.email.value.trim(),
                profile: {
                    phone: form.phone.value.trim(),
                    address: form.address.value.trim(),
                    city: form.city.value.trim(),
                    country: form.country.value.trim(),
                    postal_code: form.postal_code.value.trim(),
                    gender: form.gender.value,
                    birthday: form.birthday.value,
                    avatar: form.avatar.value.trim(),
                    occupation: form.occupation.value.trim(),
                    company: form.company.value.trim(),
                    website: form.website.value.trim(),
                    github: form.github.value.trim(),
                    linkedin: form.linkedin.value.trim(),
                    skills: form.skills.value.trim(),
                    interests: form.interests.value.trim(),
                    bio: form.bio.value.trim(),
                }
            };
        }

        function openDialog(data) {
            if (data) {
                dlgTitle.textContent = '编辑用户';
                btnDelete.style.display = '';
                fillForm(data);
            } else {
                dlgTitle.textContent = '新建用户';
                btnDelete.style.display = 'none';
                fillForm({});
            }
            dlg.showModal();
        }

        dlgClose.addEventListener('click', () => dlg.close());
        btnCancel.addEventListener('click', () => dlg.close());

        btnDelete.addEventListener('click', async () => {
            const id = form.dataset.id;
            if (!id) return;
            if (confirm('确认删除该用户？')) {
                try {
                    await api.remove(id);
                    dlg.close();
                    load();
                } catch (e) {
                    alert('删除失败: ' + e.message);
                }
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = form.dataset.id;
            const userData = collectFormData();

            try {
                if (id) {
                    await api.update(id, userData);
                    alert('更新成功！');
                } else {
                    await api.create(userData);
                    alert('创建成功！');
                }
                dlg.close();
                load();
            } catch (err) {
                alert('保存失败：' + err.message);
                console.error('保存错误:', err);
            }
        });

        // 首次加载
        load();
    </script>
</body>

</html>